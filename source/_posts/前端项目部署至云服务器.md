---
title: é¡¹ç›®éƒ¨ç½²ï¼Œæµ…è°ˆCI/CD
date: 2022-04-08 11:46:07
categories:
  - FE
tags:
  - webpack
  - FE
  - äº‘æœåŠ¡å™¨
---

## ä»‹ç»

é¡¹ç›®éƒ¨ç½²çš„æ–¹å¼å¾ˆå¤šï¼Œé’ˆå¯¹ä¸åŒçš„é¡¹ç›®ä¹Ÿæœ‰ä¸ä¸€æ ·æ–¹å¼ï¼Œä¸‹é¢è¯´ä¸€ä¸‹å¸¸è§çš„é¡¹ç›®éƒ¨ç½²æ˜¯æ€ä¹ˆæ ·çš„ã€‚

é¦–å…ˆå‘¢ä½ éœ€è¦æœ‰ä¸€ä¸ªäº‘æœåŠ¡å™¨ ğŸ’°ã€‚

## åŸºæœ¬é…ç½®

ä»¥ node.js çš„ express ä¸ºä¾‹,

```js
const express = require("express");
const app = express();
// é™æ€èµ„æºè·¯å¾„
app.use(express.static(path.join(__dirname, "dist")));
```

ç„¶åå°†æ‰“åŒ…å¥½çš„ dist æ–‡ä»¶çš„å†…å®¹æ”¾åˆ° dist ç›®å½•ä¸‹ï¼Œæ­¤æ—¶å‰ç«¯ä»£ç çš„ BASE_URL å¯ä»¥ä¸ºç©ºï¼Œè¿™æ ·ä¼šè‡ªåŠ¨å¸¦ä¸Šå½“å‰çš„è·¯å¾„ç›´æ¥è¯·æ±‚åç«¯æ¥å£ã€‚ç„¶åä½¿ç”¨`pm2`å¯åŠ¨åç«¯çš„ node æœåŠ¡`pm2 start app.js --name expo`ï¼Œç„¶åä½¿ç”¨ nginx å°†åŸŸåå’Œç«¯å£å…³è”èµ·æ¥å³å¯ã€‚

```conf
  server {
      listen 443;
      ssl   on;
      #é…ç½®HTTPSçš„é»˜è®¤è®¿é—®ç«¯å£ä¸º443ã€‚
      #å¦‚æœæœªåœ¨æ­¤å¤„é…ç½®HTTPSçš„é»˜è®¤è®¿é—®ç«¯å£ï¼Œå¯èƒ½ä¼šé€ æˆNginxæ— æ³•å¯åŠ¨ã€‚
      #å¦‚æœæ‚¨ä½¿ç”¨Nginx 1.15.0åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨listen 443 sslä»£æ›¿listen 443å’Œssl onã€‚
      server_name expo.liufashi.top; #éœ€è¦å°†yourdomainæ›¿æ¢æˆè¯ä¹¦ç»‘å®šçš„åŸŸåã€‚

      ssl_certificate ssl/expo/expo.liufashi.top.pem;  #éœ€è¦å°†cert-file-name.pemæ›¿æ¢æˆå·²ä¸Šä¼ çš„è¯ä¹¦æ–‡ä»¶çš„åç§°ã€‚
      ssl_certificate_key  ssl/expo/expo.liufashi.top.key; #éœ€è¦å°†cert-file-name.keyæ›¿æ¢æˆå·²ä¸Šä¼ çš„è¯ä¹¦ç§é’¥æ–‡ä»¶çš„åç§°ã€‚
      ssl_session_timeout 5m;
      ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
      #è¡¨ç¤ºä½¿ç”¨çš„åŠ å¯†å¥—ä»¶çš„ç±»å‹ã€‚
      ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3; #è¡¨ç¤ºä½¿ç”¨çš„TLSåè®®çš„ç±»å‹ã€‚
      ssl_prefer_server_ciphers on;
      location / {
          root /root/app/dist;
          index index.html;
          proxy_pass http://localhost:3000;
      }
  }
  server {
      listen 80;
      server_name expo.liufashi.top; #éœ€è¦å°†yourdomainæ›¿æ¢æˆè¯ä¹¦ç»‘å®šçš„åŸŸåã€‚
      rewrite ^(.*)$ https://$host$1;
  }
```

[æŸ¥çœ‹é¡¹ç›®](https://expo.liufashi.top)ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯åªéœ€è¦å¯åŠ¨ä¸€ä¸ªåç«¯æœåŠ¡ã€‚ç„¶åä½¿ç”¨`<å…¬ç½‘ ip>:<ç«¯å£>`å°±å¯ä»¥è®¿é—®äº†ã€‚ä½†æ˜¯å½“å‰ç«¯åº”ç”¨å’Œåç«¯æœåŠ¡ä¸ä½¿ç”¨åŒä¸€ä¸ªåŸŸåçš„æ—¶å€™è¿™ä¸ªæ–¹æ³•å°±ä¸å®ç”¨äº†ã€‚è¿™ä¸ªæ—¶å€™è¿˜éœ€è¦å°†ä¸åŒçš„åŸŸåä»£ç†åˆ°å¯¹åº”å‰ç«¯åº”ç”¨çš„é™æ€èµ„æºï¼Œç„¶åå‰ç«¯çš„ BASE_URL éœ€è¦æ—¶åç«¯çš„åŸŸåã€‚ä¾‹å¦‚ä¸Šé¢çš„åº”ç”¨è¿˜æœ‰ä¸ªç§»åŠ¨ç«¯
pc ç«¯é…ç½®

```conf
  server {
      listen 443;
      ssl   on;
      server_name expo.liufashi.top;
      ...
      location / {
        root   /apps/expo-pc/dist;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
      }
  }
```

ç§»åŠ¨ç«¯é…ç½®

```conf
  server {
      listen 443;
      ssl   on;
      server_name mobile.expo.liufashi.top;
      ...
      location / {
        root   /apps/expo-mobile/dist;
        index  index.html index.htm;
        try_files $uri $uri/ /index.html;
      }
  }
```

## é¡¹ç›®éƒ¨ç½²

ç®€å•çš„æ¥è¯´å°†é¡¹ç›®ä»ç”µè„‘é‡Œå¤åˆ¶åˆ°äº‘æœåŠ¡å™¨ä¸Šï¼Œäº‘æœåŠ¡å™¨å¯ä»¥ç†è§£ä¸ºå¦ä¸€å°ç”µè„‘ï¼Œåªä¸è¿‡æ˜¯ linuxï¼ˆä¹Ÿå¯ä»¥è´­ä¹°å…¶ä»–ç³»ç»Ÿï¼‰ï¼Œéœ€è¦ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·æ“ä½œï¼Œæˆ–è€…ä½¿ç”¨å…¶ä»–å¯è§†åŒ–å·¥å…·ï¼Œäº¦æˆ–æ˜¯ç»™ä½ çš„ linux ç³»ç»Ÿå®‰è£…æ¡Œé¢ GNOMEã€Pantheon ç­‰ç­‰ï¼ˆæœåŠ¡å™¨é…ç½®æœ‰é™ï¼Œäº²æµ‹å¾ˆå¡ï¼‰ã€‚

### åˆ€è€•ç«ç§

ä½¿ç”¨ scp å‘½ä»¤å°†é¡¹ç›®ä»æœ¬åœ°å¤åˆ¶åˆ°äº‘æœåŠ¡å™¨`scp -r <æœ¬åœ°è·¯å¾„> <user>@å…¬ç½‘ip>:<æœåŠ¡å™¨ç›®æ ‡è·¯å¾„>`ï¼Œç„¶åä½¿ç”¨å¯†ç è¿æ¥ï¼Œå¦‚æœé…ç½®äº† ssh å…å¯†å°±å¯ä»¥ç›´æ¥å¤åˆ¶è¿‡å»äº†ã€‚

ç„¶åè¿˜æœ‰ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨æœåŠ¡å™¨ä¸Šé…ç½® gitï¼Œæ‹‰å–ä»£ç ->å®‰è£…ä¾èµ–->æ‰“åŒ…->ç§»åŠ¨æ‰“åŒ…äº§ç‰©ã€‚
ä»¥ä¸Šè¿™äº›æ–¹æ³•è¿‡äºéº»çƒ¦ï¼Œå¦‚æœæ˜¯è‡ªå·±çš„æœåŠ¡å™¨æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå¯ä»¥è‡ªå·±æƒ³æ€ä¹ˆç©æ€ä¹ˆç©ï¼Œå¦‚æœæ˜¯åœ¨å…¬å¸çš„è¯å®ç°å¯èƒ½æ¯æ¬¡æ›´æ–°å†…å®¹éœ€è¦è”ç³»è¿ç»´çš„åŒå­¦ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„å·¥å…·äº†ï¼Œä¸€æ¬¡é…ç½®ï¼Œåé¢éƒ½èƒ½è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚

### git action å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

å¯ä»¥å‚è€ƒ[GitHub Actions å…¥é—¨æ•™ç¨‹](https://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html)

> GitHub æœ‰ä¸€ä¸ªå®˜æ–¹å¸‚åœºï¼Œå¯ä»¥æœç´¢åˆ°ä»–äººæäº¤çš„ actionsã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª awesome actions çš„ä»“åº“ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸å°‘ actionã€‚å¦‚æœä½ éœ€è¦æŸä¸ª actionï¼Œä¸å¿…è‡ªå·±å†™å¤æ‚çš„è„šæœ¬ï¼Œç›´æ¥å¼•ç”¨ä»–äººå†™å¥½çš„ action å³å¯ï¼Œæ•´ä¸ªæŒç»­é›†æˆè¿‡ç¨‹ï¼Œå°±å˜æˆäº†ä¸€ä¸ª actions çš„ç»„åˆã€‚è¿™å°±æ˜¯ GitHub Actions æœ€ç‰¹åˆ«çš„åœ°æ–¹ã€‚

GitHub Actions æœ‰ä¸€äº›è‡ªå·±çš„æœ¯è¯­ã€‚

1. workflow ï¼ˆå·¥ä½œæµç¨‹ï¼‰ï¼šæŒç»­é›†æˆä¸€æ¬¡è¿è¡Œçš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ª workflowã€‚

2. job ï¼ˆä»»åŠ¡ï¼‰ï¼šä¸€ä¸ª workflow ç”±ä¸€ä¸ªæˆ–å¤šä¸ª jobs æ„æˆï¼Œå«ä¹‰æ˜¯ä¸€æ¬¡æŒç»­é›†æˆçš„è¿è¡Œï¼Œå¯ä»¥å®Œæˆå¤šä¸ªä»»åŠ¡ã€‚

3. stepï¼ˆæ­¥éª¤ï¼‰ï¼šæ¯ä¸ª job ç”±å¤šä¸ª step æ„æˆï¼Œä¸€æ­¥æ­¥å®Œæˆã€‚

   - nameï¼šè¯¥æ­¥éª¤çš„åå­—ï¼Œåœ¨å‘½ä»¤è¡Œèƒ½å¤Ÿçœ‹åˆ°ï¼Œ
   - usesï¼šéœ€è¦å®‰è£…çš„ç¬¬ä¸‰æ–¹åŒ…
   - withï¼šåŒ…éœ€è¦çš„ä¸€äº›å‚æ•°

4. action ï¼ˆåŠ¨ä½œï¼‰ï¼šæ¯ä¸ª step å¯ä»¥ä¾æ¬¡æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå‘½ä»¤ï¼ˆactionï¼‰ã€‚

çŸ¥é“äº†è¿™äº›æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç®€æ˜“çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

é¦–å…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º.github/workflows æ–‡ä»¶å¤¹ï¼Œä»“åº“ä¸­çš„ action ä¼šæ£€æµ‹åˆ°è¯¥æ–‡ä»¶åŠ ä¸‹çš„ yml æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ª yml æ–‡ä»¶éšä¾¿å–åï¼Œæˆ‘è¿™é‡Œå« deploy.yml,æ·»åŠ å¦‚ä¸‹ä»£ç ï¼Œä»£ç ä¸­æœ‰æ³¨é‡Šä¼šå‘Šè¯‰ä½ æ¯ä¸€è¡Œçš„ä½œç”¨ã€‚

```yml
# æŒ‡å®šå·¥ä½œæµç¨‹çš„åç§°
name: CI/CD
# æŒ‡å®šæ­¤å·¥ä½œæµç¨‹çš„è§¦å‘äº‹ä»¶Eventã€‚ æ­¤ç¤ºä¾‹ä½¿ç”¨ æ¨é€ äº‹ä»¶ï¼Œå³æ‰§è¡Œpushåï¼Œè§¦å‘è¯¥æµæ°´çº¿çš„æ‰§è¡Œ
on: [push]
# å­˜æ”¾ learn-github-actions å·¥ä½œæµç¨‹ä¸­çš„æ‰€æœ‰Job
jobs:
# æŒ‡å®šä¸€ä¸ªJobçš„åç§°ä¸ºcheck-bats-version
deploy:
  runs-on: ubuntu-latest
  steps:
    # æ‹‰å–é¡¹ç›®ä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v3
    # ç»™å½“å‰ç¯å¢ƒä¸‹è½½node
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "14.x"
    - name: use yarn.js 1.22.19
      # ä½¿ç”¨actionåº“  actions/setup-nodeå®‰è£…yarn
      uses: actions/setup-node@v3
      with:
        yarn-version: 1.22.19
    # æ£€æŸ¥ç¼“å­˜
    # å¦‚æœkeyå‘½ä¸­ç¼“å­˜åˆ™ç›´æ¥å°†ç¼“å­˜çš„æ–‡ä»¶è¿˜åŸåˆ° path ç›®å½•ï¼Œä»è€Œå‡å°‘æµæ°´çº¿è¿è¡Œæ—¶é—´
    # è‹¥ key æ²¡å‘½ä¸­ç¼“å­˜æ—¶ï¼Œåœ¨å½“å‰JobæˆåŠŸå®Œæˆæ—¶å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°ç¼“å­˜
    - name: Cache
      # ç¼“å­˜å‘½ä¸­ç»“æœä¼šå­˜å‚¨åœ¨steps.[id].outputs.cache-hité‡Œï¼Œè¯¥å˜é‡åœ¨ç»§åçš„stepä¸­å¯è¯»
      id: cache-dependencies
      uses: actions/cache@v3
      with:
        # ç¼“å­˜æ–‡ä»¶ç›®å½•çš„è·¯å¾„
        path: |
          **/node_modules
        # keyä¸­å®šä¹‰ç¼“å­˜æ ‡å¿—ä½çš„ç”Ÿæˆæ–¹å¼ã€‚runner.OSæŒ‡å½“å‰ç¯å¢ƒçš„ç³»ç»Ÿã€‚å¤–åŠ å¯¹yarn.lockå†…å®¹ç”Ÿæˆå“ˆå¸Œç ä½œä¸ºkeyå€¼ï¼Œå¦‚æœyarn.lockæ”¹å˜åˆ™ä»£è¡¨ä¾èµ–æœ‰å˜åŒ–ã€‚
        # è¿™é‡Œç”¨yarn.lockè€Œä¸æ˜¯package.jsonæ˜¯å› ä¸ºpackage.jsonä¸­è¿˜æœ‰versionå’Œdescriptionä¹‹ç±»çš„æè¿°é¡¹ç›®ä½†å’Œä¾èµ–æ— å…³çš„å±æ€§
        key: ${{runner.OS}}-${{hashFiles('**/yarn.lock')}}
    # å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      # å¦‚æœç¼“å­˜æ ‡å¿—ä½æ²¡å‘½ä¸­ï¼Œåˆ™æ‰§è¡Œè¯¥stepã€‚å¦åˆ™å°±è·³è¿‡è¯¥step
      if: steps.cache-dependencies.outputs.cache-hit != 'true'
      run: yarn
    # è¿è¡Œä»£ç æ‰“åŒ…
    - name: node.jsæ„å»º
      run: CI=false yarn run build
    - name: æŸ¥çœ‹æ–‡ä»¶
      run: ls -a # æŸ¥çœ‹æ‰“åŒ…åçš„ç›®å½•æ–‡ä»¶
    - name: ossä¸Šä¼ 
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }} # æœåŠ¡å™¨host
        username: ${{ secrets.USER }} # æœåŠ¡å™¨ç”¨æˆ·å
        password: ${{ secrets.PASSWORD }} # æœåŠ¡å™¨å¯†ç 
        source: "./build" # éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶, å¤šæ–‡ä»¶ä½¿ç”¨é€—å·éš”å¼€
        target: "/apps/react-admin/" # ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„ä»€ä¹ˆä½ç½®
```

ä¸Šè¿°æ¶‰åŠåˆ°ç§å¯†ä¿¡æ¯çš„æˆ‘ä»¬ä¼šåœ¨ä»“åº“ä¸­é…ç½®ï¼Œç„¶åæ˜¯é‡‡ç”¨`${{ secrets.<name> }}`å¯ä»¥æ‹¿åˆ°
{% gallery %}![æ·»åŠ å‚æ•°](https://blog.liufashi.top/img/cicd/flow.png){% endgallery %}
å½“ç„¶ä»¥ä¸Šåªæ˜¯æä¾›äº†æœ€ç®€å•çš„è‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ–¹å¼ï¼Œæœ€åæ‰“åŒ…äº§ç‰©ä¸Šä¼ é‡‡ç”¨çš„æ˜¯`appleboy/scp-action@master`è¿™ä¸ªåŒ…ã€‚è¿˜æœ‰ç±»ä¼¼çš„å¦‚`easingthemes/ssh-deploy@v2.1.1`ç­‰ç­‰

### ä½¿ç”¨ jenkins å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²

### CI/CD

å…ˆæ¥è¯´ä¸‹ä»€ä¹ˆæ˜¯ CIï¼ŒæŒç»­é›†æˆï¼ˆContinuous Integrationï¼‰çš„ç¼©å†™ã€‚æŒ‡çš„ä¸€ä¸ªæµç¨‹ï¼Œå³å½“æœ‰æ–°çš„éœ€æ±‚æ—¶

1. ä»æœ€æ–°çš„ master åˆ†æ”¯åˆ‡å‡ºä¸€ä¸ª feature åˆ†æ”¯è¿›è¡Œå¼€å‘
2. å¼€å‘è¿‡ç¨‹ä¸­å°†æ›´æ”¹æäº¤åˆ° feature åˆ†æ”¯
3. å°† feature çš„ä»£ç éƒ¨ç½²è‡³æµ‹è¯•ç¯å¢ƒï¼Œè¿›è¡Œæµ‹è¯•
4. é€šè¿‡æµ‹è¯•åå°† feature åˆ†æ”¯çš„ä»£ç é€šè¿‡ pull_request åˆå¹¶åˆ° master

è€Œ CD é€šå¸¸è§£é‡Šä¸ºä¸¤ä¸ªæ­¥éª¤æŒç»­äº¤ä»˜ï¼ˆContinuous Deliveryï¼‰å’ŒæŒç»­éƒ¨ç½²ï¼ˆContinuous Deploymentï¼‰,æŒç»­äº¤ä»˜æŒ‡çš„æ˜¯ï¼Œé¢‘ç¹åœ°å°†è½¯ä»¶çš„æ–°ç‰ˆæœ¬ï¼Œäº¤ä»˜ç»™è´¨é‡å›¢é˜Ÿï¼Œä»¥ä¾›è¯„å®¡ã€‚å¦‚æœè¯„å®¡é€šè¿‡ï¼Œä»£ç å°±è¿›å…¥ç”Ÿäº§é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯æŒç»­éƒ¨ç½²
{% gallery %}![CI/CD](https://blog.liufashi.top/img/cicd/cicd.png){% endgallery %}
ä»¥ä¸Šæ˜¯æˆ‘ç»“åˆå…¬å¸ä¸šåŠ¡å¯¹ CI/CD çš„ç†è§£ï¼Œä¸åŒæƒ…å†µä¸‹å¯èƒ½ä¼šæœ‰äº›è®¸å‡ºå…¥ã€‚
