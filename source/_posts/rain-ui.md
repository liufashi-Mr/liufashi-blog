---
title: å…³äºæˆ‘çš„ç»„ä»¶åº“ rain-ui
date: 2023-02-02 09:51:40
categories:
  - FE
  - react
tags:
  - react
  - FE
  - rain-ui
  - ç»„ä»¶åº“
---

## å‰è¨€

æœ€è¿‘ä¸¤ä¸ªæœˆæ¥åšä¸»åœ¨åšä¸€ä»¶äº‹æƒ…ï¼Œå½»åº•é‡æ„äº†ä¹‹å‰æ­å»ºçš„ç»„ä»¶åº“ï¼Œç›®å‰å·²ç»åˆå…·é›å½¢ï¼Œ[å‰å¾€](https://rain-ui.liufashi.top/)ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†å¾ˆå¤šé—®é¢˜ï¼Œè¿™é‡Œåˆ†äº«ä¸‹è¿‡ç¨‹å’Œè§£å†³æ–¹å¼ï¼ŒåŒæ—¶ä¹Ÿä¼šå°†æˆ‘è‡³ä»Šå°šæœªæƒ³é€šçš„é—®é¢˜æå‡ºæ¥ï¼Œè¿˜æœ›æŒ‡ç‚¹ä¸€äºŒã€‚

## é¡¹ç›®å‡†å¤‡

ä¹‹å‰çš„ç»„ä»¶åº“æ˜¯æºäºå…¬å¸çš„éœ€æ±‚ï¼ŒåŸºäº[tuya expo](https://expo.tuya.com)çš„ä¸»é¢˜å’Œæ‰€éœ€è¦çš„ç»„ä»¶è¿›è¡Œå®šåˆ¶å¼€å‘çš„ç»„ä»¶åº“ï¼Œéœ€æ±‚å®Œæˆä¹‹åè®©æˆ‘èŒç”Ÿäº†å†™ä¸ªç»„ä»¶åº“çš„æƒ³æ³•ã€‚

é¦–å…ˆï¼Œæˆ‘æƒ³å†™çš„ç»„ä»¶åº“æ˜¯ä¸€ä¸ªå®ç”¨æ€§è¾ƒå¤§çš„ç»„ä»¶åº“ä¸æ˜¯æŸä¸ªé¡¹ç›®å®šåˆ¶çš„ï¼Œå› æ­¤éœ€è¦å°†é¡¹ç›®çš„ä¸€äº›å˜é‡æš´éœ²å‡ºæ¥ï¼Œä¾¿äºä¿®æ”¹ã€‚å…¶æ¬¡éœ€è¦æ”¯æŒæ·±è‰²æ¨¡å¼ä»¥åŠç´§å‡‘æ¨¡å¼ã€‚å¯ä»¥åœ¨é¡¹ç›®è¿è¡Œæ—¶ä½¿ç”¨jsä¿®æ”¹ä¸»é¢˜è‰²ã€‚åç»­å°†åœ¨ä¸»é¢˜ç«™ç‚¹æ¨å‡ºä¸»é¢˜é€‰é¡¹

## æ–¹æ¡ˆé€‰æ‹©

- é¦–å…ˆæƒ³è¦åœ¨è¿è¡Œæ—¶ä¿®æ”¹ä¸»é¢˜è‰²ï¼Œèƒ½åšåˆ°è¿™ä¸€ç‚¹çš„æ–¹æ¡ˆæœ€åˆé€‚çš„å°±æ˜¯é‡‡ç”¨ `css variables` æˆ–è€…æ˜¯ `css in js`, `css in js`æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡jså†™æ³•å†™çš„cssï¼Œå­˜åœ¨äºjsçš„ä»£ç ä¸­ï¼Œä¼˜åŠ¿åœ¨äºæˆ‘ä»¬å¯ä»¥ä»£ç çš„ä»»ä½•æ—¶å€™ä¿®æ”¹å…¶ä¸­çš„å˜é‡ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“å…¶ä»–ç»„ä»¶ï¼Œä½†æ˜¯è¿‡å¤šçš„jsä¼šå¢åŠ è¿è¡Œæ—¶çš„æ¶ˆè€—ï¼Œè€Œ `css variables` åˆ™æ˜¯éœ€è¦é€šè¿‡jsæ“ä½œdom ä¿®æ”¹ `css variables` æŒ‚è½½èŠ‚ç‚¹çš„csså˜é‡ï¼Œå½“ç„¶å¯¹è±¡èƒ½å½±å“å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œè€Œä¸”ä»…ä»…åªåœ¨åˆ‡æ¢çš„æ—¶å€™æ‰§è¡Œä¸å½±å“é¡¹ç›®æ­£å¸¸ä»£ç çš„æ€§èƒ½ã€‚ ç”±äºé¡¹ç›®çš„ä¸»é¢˜æ²¡æœ‰æ”¯æŒæŸä¸€ä¸ªç»„ä»¶å•ç‹¬è¿›è¡Œä¸»é¢˜ä¿®æ”¹ï¼ˆantd 5.x æ”¯æŒï¼‰ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨`css variables + less`çš„æ–¹å¼ï¼Œæ›´å°çš„ä½¿ç”¨åŠæ›´å°çš„æ€§èƒ½æ¶ˆè€—ã€‚
- è‰²å½©é€‚é…ï¼Œä¾‹å¦‚ä¸€ä¸ªæŒ‰é’®é¢œè‰²å¯èƒ½æ˜¯è“è‰²ï¼Œhoverä¹‹åé¢œè‰²æµ…ä¸€ç‚¹çš„è“è‰²ï¼Œè¿™ä¸ªæ—¶å€™ç”¨æˆ·å°†`primary-color`ä¿®æ”¹ä¸ºæ©™è‰²ï¼Œé‚£ä¹ˆæŒ‰é’®hover çš„æ—¶å€™ä¹Ÿéœ€è¦æ˜¯æµ…ä¸€ç‚¹çš„æ©™è‰²ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¸å¯èƒ½æŠŠæ‰€æœ‰æƒ…å†µçš„å˜é‡éƒ½æš´éœ²å‡ºæ¥ä¾›ç”¨æˆ·æ¶ˆè´¹ï¼Œå› æ­¤éœ€è¦æ ¹æ®ä¸»è‰²è®¡ç®—å…¶ä½™é¢œè‰²ã€‚è¿™é‡Œé‡‡ç”¨äº† `@ant-design/colors` çš„æ–¹å¼ï¼Œæ ¹æ®é¢œè‰²è®¡ç®—å‡ºå¯¹åº”æ¸å˜çš„æ˜¯ä¸ªè‰²é˜¶ã€‚
- æ·±è‰²æ¨¡å¼ï¼Œåˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼ä¹‹åä¸ºäº†æ›´åŠ çš„èˆ’é€‚è§†è§‰æ•ˆæœï¼Œç»„ä»¶çš„é¢œè‰²éœ€è¦è°ƒæ•´ã€‚è¿™é‡ŒåŒæ ·æ˜¯`@ant-design/colors`ï¼Œé…ç½®æ·±è‰²çš„èƒŒæ™¯é¢œè‰²ï¼Œæ ¹æ®èƒŒæ™¯è‰²å’ŒåŸæœ‰é¢œè‰²è®¡ç®—å‡ºæ·±è‰²æ¨¡å¼ä¸‹çš„é¢œè‰²ã€‚

## ç»„ä»¶æ‰“åŒ…

ä»¤æˆ‘å¤´å¤§çš„åœ°æ–¹æ¥äº†ï¼Œé¦–å…ˆæ˜¯å·¥å…·é€‰æ‹©ï¼Œæ˜¾ç„¶rollup æ”¯æŒesm cjs umd ç­‰äº§ç‰©çš„æ„å»ºï¼Œæ›´é€‚åˆåº“çš„æ‰“åŒ…ï¼Œå¹¶ä¸”é…ç½®ç®€å•ã€‚ä½†æ˜¯äº†è§£åˆ°webpack5.x æ”¯æŒäº†æ„å»ºesmçš„èƒ½åŠ›ï¼Œå‡ºäºå¯¹è€æœ‹å‹çš„åçˆ±æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†webpackã€‚

### webpacké…ç½®

é¦–å…ˆå¸¸è§çš„ less css çš„é…ç½®å°±ä¸å¤šèµ˜è¿°äº†ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸€ç¯‡ {% post_link react-cli %}

```js
const path = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const TerserWebpackPlugin = require('terser-webpack-plugin');
const CopyWebpackPlugin = require('copy-webpack-plugin');
const CompressionPlugin = require('compression-webpack-plugin');
const getStyleLoaders = (preProcessor) => {
  return [
    MiniCssExtractPlugin.loader,
    'css-loader',
    {
      loader: 'postcss-loader',
      options: {
        postcssOptions: {
          plugins: ['postcss-preset-env'],
        },
      },
    },
    preProcessor === 'less-loader'
      ? {
          loader: 'less-loader',
          options: {
            lessOptions: {
              javascriptEnabled: true,
            },
          },
        }
      : preProcessor,
  ].filter(Boolean);
};
const baseConfig = {
  entry: './src/index.ts',
  module: {
    rules: [
      {
        oneOf: [
          {
            test: /\.css$/,
            use: getStyleLoaders(),
          },
          {
            test: /\.less$/,
            use: getStyleLoaders('less-loader'),
          },
          {
            test: /\.(js|jsx)$/,
            use: [
              {
                loader: 'babel-loader',
                options: {
                  cacheDirectory: true,
                  cacheCompression: false,
                  plugins: [['@babel/plugin-transform-runtime']],
                  presets: [['@babel/preset-env']],
                  ignore: ['node_modules/**'],
                },
              },
            ],
          },
          {
            test: /\.(ts|tsx)$/,
            use: 'ts-loader',
          },
        ],
      },
    ],
  },
  plugins: [
    // åŒäº‹ç”Ÿæˆgzipçš„äº§ç‰©ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æä¾›æ›´å°çš„ä½“ç§¯
    new CompressionPlugin({
      algorithm: 'gzip',
      test: /\.(js|css|json|txt|html|ico|svg)(\?.*)?$/i,
      threshold: 10240,
      minRatio: 0.8,
      deleteOriginalAssets: false,
    }),
  ],
  optimization: {
    minimize: true,
    // å‹ç¼©çš„æ“ä½œ
    minimizer: [
      // å‹ç¼©css
      new MiniCssExtractPlugin({
        // è¿™é‡Œçš„ç›®å½•åœ¨dist/[mode] æ‰€ä»¥ç”¨ ../ æå‡ºæ¥
        filename: '../style/rain-ui.min.css',
      }),
      // å‹ç¼©js
      new TerserWebpackPlugin(),
    ],
  },
  resolve: {
    extensions: ['.tsx', '.ts', '.json', '.js', '.jsx'],
  },
  mode: 'production',
  devtool: 'source-map',
};
```

### umd

é¦–å…ˆæ˜¯æ‰“åŒ…ç”Ÿæˆ `umd` çš„äº§ç‰©ï¼Œ`umd`çš„äº§ç‰©æ”¯æŒå¤šç§æ¨¡å—ä»¥åŠ`script` æ ‡ç­¾å¼•å…¥ï¼Œä½“ç§¯ç¨å¤§ï¼Œé€šå¸¸ä½œä¸ºå¤‡é€‰çš„æ–¹æ¡ˆã€‚åœ¨ä»¥ä¸Šçš„baseConfigä¸­æ·»åŠ  `output`ï¼Œè®¾ç½®`libraryTarget:umd`

```js
module.exports ={
    output: {
      path: path.resolve(__dirname, './dist/umd'),
      filename: 'index.js',
      libraryTarget: 'umd',
    },
    ...baseConfig
}
```

### cjs

ç„¶åæ˜¯ `commonjs` ï¼Œç›¸æ¯”ä¹‹ä¸‹æ‹¥æœ‰æ›´å°çš„ä½“ç§¯ï¼Œåœ¨webpackä¸æ”¯æŒES Moduleçš„æ—¥å­é‡Œå¸¸å¸¸ä½œä¸ºé¦–é€‰ã€‚

```js
module.exports ={
    output: {
      path: path.resolve(__dirname, './dist/cjs'),
      filename: 'index.js',
      libraryTarget: 'commonjs',
    },
    ...baseConfig
}
```

### esm

æœ€åæ˜¯æ–°å® `ES Module`,å¤©ç„¶æ”¯æŒä¾èµ–åˆ†ç¦»ï¼Œæ”¯æŒ`Tree-shaking`,åŸºäº ESM çš„èƒ½åŠ›ï¼Œæ¨¡å—åŒ–äº¤ç»™æµè§ˆå™¨ç«¯ï¼Œä¸å­˜åœ¨èµ„æºé‡å¤åŠ è½½é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåŸºäºes çš„æ„å»ºå·¥å…·ä¼šæ¯”webpackå¿«å¾—å¤šã€‚
webpack5 æ„å»ºesmäº§ç‰©çš„æ—¶å€™éœ€è¦è®¾ç½®`experiments.outputModule=true` ã€‚

```js
module.exports ={
    output: {
      path: path.resolve(__dirname, './dist/esm'),
      filename: 'index.js',
      libraryTarget: 'module',
      chunkFormat: 'module',
    },
    experiments: {
      outputModule: true,
    },
}
```

### é…ç½®åˆå¹¶

webpack5 æ”¯æŒ å¯¼å‡ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åç»™æ•°ç»„æ¯ä¸€é¡¹æ·»åŠ  `name` æœ€åé‡‡ç”¨ `webpack --config-name esm` çš„æ–¹å¼æ‰§è¡Œã€‚ä¿®æ”¹ä»£ç å¦‚ä¸‹

``` js
module.exports = [
  {
    name: 'esm',
    output: {
      path: path.resolve(__dirname, './dist/esm'),
      filename: 'index.js',
      libraryTarget: 'module',
      chunkFormat: 'module',
    },
    experiments: {
      outputModule: true,
    },
    ...baseConfig,
  },
  {
    name: 'cjs',
    output: {
      path: path.resolve(__dirname, './dist/cjs'),
      filename: 'index.js',
      libraryTarget: 'commonjs',
    },
  },
  {
    name: 'umd',
    output: {
      path: path.resolve(__dirname, './dist/umd'),
      filename: 'index.js',
      libraryTarget: 'umd',
    },

    ...baseConfig,
  },
];
```

`package.json` æ·»åŠ å‘½ä»¤

```json
{
    "build": "rm -rf ./dist &&  npm run build:esm & npm run build:umd & npm run build:cjs",
    "build:esm": "webpack --config-name esm",
    "build:cjs": "webpack --config-name cjs",
    "build:umd": "webpack --config-name umd",
}
```

### é—®é¢˜

åœ¨å¼€å‘ä¸€åˆ‡é¡ºåˆ©çš„æ—¶å€™å°†åŒ…æ‰“åŒ…å¥½å‘å¸ƒåˆ°npmä¹‹åï¼Œåœ¨é¡¹ç›®ä¸­å¼•ç”¨æŠ¥é”™ `Minified React error #321;`
![æŠ¥é”™](https://blog.liufashi.top/img/rain-ui/1.png)

>Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons: 1. You might have mismatching versions of React and the renderer (such as React DOM) 2. You might be breaking the Rules of Hooks 3. You might have more than one copy of React in the same app See <https://reactjs.org/link/invalid-hook-call> for tips about how to debug and fix this problem.

æ ¹æ®å®˜ç½‘çš„æç¤º ï¼š

1. ä¸åŒ¹é…çš„reactå’Œreact-domç‰ˆæœ¬
2. è¿åäº†hooksè§„åˆ™
3. åº”ç”¨ç¨‹åºä¸­æ‹¥æœ‰å¤šä¸ªreactå‰¯æœ¬

æ ¹æ®æç¤ºå°±æƒ³åˆ°éœ€è¦ä½¿ç”¨externalså°†reactå’Œreact-domæŠ½ç¦»å‡ºæ¥ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç :

```js
{ 
    "externals": {
        "react": {
        commonjs: 'react',
        commonjs2: 'react',
        module: 'react',
        amd: 'react',
        root: 'React',
        },
        'react-dom': {
        commonjs: 'react-dom',
        commonjs2: 'react-dom',
        module: 'react-dom',
        amd: 'react-dom',
        root: 'ReactDOM',
        },
  },
}
```

é—®é¢˜åˆ°è¿™é‡Œå°±è§£å†³äº†ã€‚

### èŠä¸€èŠç»„ä»¶åº“ä¸­ package.json éœ€è¦çš„ä¿®æ”¹

`main`: å¼•ç”¨æ–‡ä»¶çš„å…¥å£ï¼Œé€šå¸¸æ˜¯ä½œä¸ºå¤‡é€‰ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºumdçš„æ„å»ºäº§ç‰©ã€‚
`types/typing`: ç±»å‹æ–‡ä»¶ï¼Œåœ¨tsä¸­ä½¿ç”¨åº“æ—¶ä¼šåœ¨`types/typing`æŒ‡å®šçš„ç›®å½•æ‰¾ç±»å‹æ–‡ä»¶ã€‚
`module`: åœ¨ES Module å¼•ç”¨é¡¹ç›®çš„æ—¶å€™æŒ‡å®šçš„è·¯å¾„ï¼Œä¼˜å…ˆçº§é«˜äºmain è®¾ç½®ä¸ºåº“æ„å»ºçš„esmäº§ç‰©çš„ç›®å½•ã€‚
`unpkg`: CDNæ–¹å¼ä¸‹ï¼Œå¼•å…¥å½“å‰npmåŒ…çš„é“¾æ¥ã€‚

å¦å¤–ä½œä¸ºä¸€ä¸ªreactçš„ç»„ä»¶åº“ï¼Œå…¶å®¿ä¸»ç¯å¢ƒè‚¯å®šæ˜¯æœ‰`react` å’Œ `react-dom`çš„ï¼Œå› æ­¤æˆ‘ä»¬çš„ç»„ä»¶åº“ä¸éœ€è¦å®‰è£…è¿™ä¸¤ä¸ªä¾èµ–ï¼Œ
package.json è®¾ç½®

```json
  "peerDependencies": {
    "react": ">=16.14.0",
    "react-dom": ">=16.14.0"
  },
```

## é—®é¢˜

é—®é¢˜1: å¦‚æœç»„ä»¶åº“çš„ä»£ç åªä¼šåœ¨es moduleé¡¹ç›®ä¸­è¢«å¼•ç”¨ï¼Œé€šå¸¸é¡¹ç›®ä¸­éƒ½ä¼šæœ‰`@babel/preset-env`,`core-js` å¯¹jsç‰ˆæœ¬å’Œä¸€äº›æ–¹æ³•åšå…¼å®¹ï¼Œæ‰€ä»¥è¿™äº›å¤„ç†åœ¨ç»„ä»¶åº“æ‰“åŒ…æ—¶æ˜¯å¿…è¦çš„å—ï¼Ÿ

é—®é¢˜2ï¼šé¡¹ç›®æ‰“åŒ…ä¹‹ååœ¨é¡¹ç›®ä¸­å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œåœ¨`stackblitz`ä¸­ä¹Ÿæ˜¯æ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨`codesandbox`ä¸­ä¼šæŠ¥é”™`Cannot read properties of undefined (reading 'forwardRef')`, ä½†æ˜¯æ‰‹åŠ¨å¼•ç”¨ umd æˆ–è€…cjs æ¨¡å—çš„æ—¶å€™æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåªæœ‰esmä¼šæœ‰é—®é¢˜ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Œå›°æ‰°å¥½å¤šå¤©äº†ã€‚ [åœ°å€](https://codesandbox.io/s/bzotei)ã€‚

é—®é¢˜3ï¼šç»„ä»¶åº“æ‰“åŒ…ç”Ÿæˆcjsçš„æ„ä¹‰åœ¨å“ªé‡Œ æˆ‘çœ‹`antd`ç­‰ç­‰éƒ½æ„å»ºäº†è¯¥äº§ç‰©ã€‚ä»…ä»…æ˜¯å› ä¸ºä½“ç§¯å°äº umdå—

## æ€»ç»“

è¿˜æœ›æœ‰å¤§ä½¬è§£ç­”ç–‘é—®ï¼Œå¦‚æœä¸Šè¿°æ–¹æ¡ˆæœ‰ç¼ºé™·æˆ–è€…æ˜¯æœ‰ä¼˜åŒ–çš„åœ°æ–¹ä¹Ÿå¸Œæœ›ä¸åæŒ‡æ•™ã€‚

æœ€åæœ€åï¼Œæ¬¢è¿å°ä¼™ä¼´[åŠ å…¥](https://rain-ui.liufashi.top/)ğŸ‘ğŸ‘ğŸ‘
